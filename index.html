<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector de texto</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            background-color: #f7f7f7; 
            font-family: 'Inter', sans-serif;
            color: #333;
        }
        #app {
            background-color: #ffffff;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }
        button {
            transition: all 0.2s ease-in-out;
            border-radius: 9999px; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        #textToRead {
            overflow-y: auto; 
            white-space: pre-wrap; 
            min-height: 250px; 
            border-color: #ccc;
            border-radius: 0.5rem; 
            color: #1f2937;
            caret-color: #3b82f6; 
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }
        .control-group {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 0.75rem;
            background-color: #f9fafb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body class="p-4 sm:p-8 flex justify-center min-h-screen">

    <!-- CONTADOR GLOBAL DE VISITAS -->
    <div class="text-center text-sm text-gray-600 mb-4">
        Visitas totales: <span id="visitasTotales">Cargando...</span>
    </div>

    <script>
fetch("https://api.countapi.xyz/hit/emanuel-tts-lector/visitas")
  .then(response => response.json())
  .then(data => {
    document.getElementById("visitasTotales").textContent = data.value;
  })
  .catch((error) => {
    console.log("Error en CountAPI:", error);
    document.getElementById("visitasTotales").textContent = "Error";
  });
</script>

    <div id="app" class="w-full max-w-4xl p-6 sm:p-10 rounded-xl space-y-8">

        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 text-center">
            üéôÔ∏è Lector de Texto
        </h1>

        <p class="text-center text-sm sm:text-base text-gray-500">
            Carga un PDF, pega texto, ajusta el volumen y navega. Haz clic o selecciona texto para empezar a leer.
        </p>
        <!-- Controles -->
        <div class="flex flex-col space-y-6 p-5 bg-gray-50 rounded-xl border border-gray-200">

            <div class="flex flex-wrap justify-center items-center gap-3 text-sm font-medium text-gray-600">

                <div class="control-group">
                    <span class="text-gray-700 text-sm font-bold mr-2">P√°rrafo Actual:</span>
                    <span id="paragraphIndexDisplay" class="font-extrabold text-lg text-blue-600">0 de 0</span>
                </div>

                <div class="control-group">
                    <label for="languageSelect" class="mr-2 whitespace-nowrap">Idioma:</label>
                    <select id="languageSelect" class="p-1 border-none rounded-md bg-transparent focus:ring-0">
                        <option value="es">Espa√±ol üá™üá∏</option>
                        <option value="en">Ingl√©s üá¨üáß</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="volumeSlider" class="mr-2 whitespace-nowrap">Volumen:</label>
                    <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" class="w-20">
                    <span id="volumeValue" class="w-8 text-right font-semibold text-xs ml-2">100%</span>
                </div>

                <div class="control-group">
                    <label for="rateSlider" class="mr-2 whitespace-nowrap">Velocidad:</label>
                    <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1.0" class="w-20">
                    <span id="rateValue" class="w-8 text-right font-semibold text-xs ml-2">1.0x</span>
                </div>
            </div>

            <!-- Botones -->
            <div class="flex flex-wrap justify-center gap-3 pt-4">

                <button id="prevParagraphButton"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-5 rounded-full shadow-md">
                    ‚è™ <span class="hidden sm:inline">P√°rrafo Anterior</span>
                </button>

                <button id="playStopButton"
                    class="bg-gray-700 hover:bg-gray-800 text-white font-extrabold py-3 px-8 rounded-full shadow-xl ring-4 ring-gray-300">
                    <span id="playStopIcon">‚ñ∂Ô∏è</span>
                    <span id="playStopText">Reproducir</span>
                </button>

                <button id="nextParagraphButton"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-5 rounded-full shadow-md">
                    <span class="hidden sm:inline">P√°rrafo Siguiente</span> ‚è©
                </button>

                <button id="clearButton"
                    class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-5 rounded-full shadow-md">
                    üóëÔ∏è <span class="hidden sm:inline">Borrar Texto</span>
                </button>
            </div>
        </div>

        <!-- PDF -->
        <div class="space-y-3 p-4 bg-blue-50 rounded-xl border border-blue-200">
            <label class="block text-lg font-bold text-blue-800">1. Cargar PDF:</label>
            <input type="file" id="pdfFileInput" accept=".pdf"
                class="w-full text-sm text-blue-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0
            file:text-sm file:font-semibold file:bg-blue-200 file:text-blue-800 hover:file:bg-blue-300 cursor-pointer" />
        </div>

        <!-- Textarea -->
        <div class="relative">
            <label class="block text-lg font-bold text-gray-700 mb-2">
                2. Texto a Leer:
            </label>

            <textarea id="textToRead"
                placeholder="Escribe o pega el texto aqu√≠. El texto extra√≠do del PDF aparecer√° aqu√≠."
                rows="10"
                class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 
                text-base cursor-text font-serif resize-none">
            </textarea>
        </div>

        <!-- Mensajes -->
        <div id="messageArea"
            class="mt-4 p-3 bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-lg hidden text-center font-medium">
        </div>

        <div class="mt-10 pt-4 border-t border-gray-300 text-center space-y-4">
            <p class="text-sm text-gray-600 font-medium">
                Autor: Emanuel Mandarini Falero
            </p>

            <div id="ad-space"
                class="bg-gray-200 p-4 rounded-lg border-2 border-dashed border-gray-400 text-gray-600 text-sm italic h-24 flex items-center justify-center">
                [Espacio reservado para anuncios]
            </div>
        </div>

    </div> <!-- FIN #app -->

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
/* ===========================
   VARIABLES GLOBALES
=========================== */
let paragraphs = [];
let currentParagraph = 0;
let isReading = false;
let utterance = null;

/* ===========================
   DIVIDIR TEXTO EN P√ÅRRAFOS
=========================== */
function updateParagraphs() {
    const raw = document.getElementById("textToRead").value.trim();
    paragraphs = raw.split(/\n\s*\n+/).filter(p => p.trim().length > 0);
    updateParagraphDisplay();
}

/* ===========================
   ACTUALIZAR DISPLAY
=========================== */
function updateParagraphDisplay() {
    const display = document.getElementById("paragraphIndexDisplay");
    if (paragraphs.length === 0) {
        display.textContent = "0 de 0";
    } else {
        display.textContent = `${currentParagraph + 1} de ${paragraphs.length}`;
    }
}

/* ===========================
   REPRODUCIR P√ÅRRAFO
=========================== */
function speakParagraph(index) {
    if (index < 0 || index >= paragraphs.length) return;

    const text = paragraphs[index];

    if (!text || text.trim().length === 0) return;

    if (utterance) speechSynthesis.cancel();

    utterance = new SpeechSynthesisUtterance(text);

    utterance.lang = document.getElementById("languageSelect").value;
    utterance.volume = parseFloat(document.getElementById("volumeSlider").value);
    utterance.rate = parseFloat(document.getElementById("rateSlider").value);

    utterance.onend = () => {
        if (isReading) {
            currentParagraph++;
            if (currentParagraph < paragraphs.length) {
                updateParagraphDisplay();
                speakParagraph(currentParagraph);
            } else {
                isReading = false;
                updatePlayStopUI();
            }
        }
    };

    speechSynthesis.speak(utterance);
}

/* ===========================
   BOT√ìN ‚ñ∂ / ‚èπ
=========================== */
function updatePlayStopUI() {
    const icon = document.getElementById("playStopIcon");
    const text = document.getElementById("playStopText");

    if (isReading) {
        icon.textContent = "‚èπ";
        text.textContent = "Detener";
    } else {
        icon.textContent = "‚ñ∂Ô∏è";
        text.textContent = "Reproducir";
    }
}

/* ===========================
   PLAY / STOP
=========================== */
document.getElementById("playStopButton").addEventListener("click", () => {
    updateParagraphs();

    if (!isReading) {
        if (paragraphs.length === 0) return;

        isReading = true;
        updatePlayStopUI();
        speakParagraph(currentParagraph);
    } else {
        isReading = false;
        speechSynthesis.cancel();
        updatePlayStopUI();
    }
});

/* ===========================
   BOTONES SIGUIENTE / ANTERIOR
=========================== */
document.getElementById("nextParagraphButton").addEventListener("click", () => {
    updateParagraphs();
    if (currentParagraph < paragraphs.length - 1) {
        currentParagraph++;
        updateParagraphDisplay();
        speakParagraph(currentParagraph);
    }
});

document.getElementById("prevParagraphButton").addEventListener("click", () => {
    updateParagraphs();
    if (currentParagraph > 0) {
        currentParagraph--;
        updateParagraphDisplay();
        speakParagraph(currentParagraph);
    }
});

/* ===========================
   BORRAR TEXTO
=========================== */
document.getElementById("clearButton").addEventListener("click", () => {
    speechSynthesis.cancel();
    document.getElementById("textToRead").value = "";
    paragraphs = [];
    currentParagraph = 0;
    isReading = false;
    updateParagraphDisplay();
    updatePlayStopUI();
});

/* ===========================
   SLIDERS
=========================== */
document.getElementById("volumeSlider").addEventListener("input", (e) => {
    document.getElementById("volumeValue").textContent =
        Math.round(e.target.value * 100) + "%";
});

document.getElementById("rateSlider").addEventListener("input", (e) => {
    document.getElementById("rateValue").textContent = e.target.value + "x";
});

/* ===========================
   LECTURA AL SELECCIONAR TEXTO
=========================== */
document.getElementById("textToRead").addEventListener("mouseup", () => {
    const selected = window.getSelection().toString().trim();
    if (selected.length > 0) {
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(selected);
        u.lang = document.getElementById("languageSelect").value;
        u.volume = parseFloat(document.getElementById("volumeSlider").value);
        u.rate = parseFloat(document.getElementById("rateSlider").value);
        speechSynthesis.speak(u);
    }
});

/* ===========================
   LEER PDF CON PDF.js
=========================== */
document.getElementById("pdfFileInput").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const arrayBuffer = await file.arrayBuffer();

    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

    let extractedText = "";

    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        extractedText += content.items.map(i => i.str).join(" ") + "\n\n";
    }

    document.getElementById("textToRead").value = extractedText.trim();

    updateParagraphs();
});

/* ===========================
   ACTUALIZAR P√ÅRRAFOS AUTOM√ÅTICO
=========================== */
document.getElementById("textToRead").addEventListener("input", updateParagraphs);

updateParagraphs();
</script>

</body>
</html>
