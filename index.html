<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">Lector de texto</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            background-color: #f7f7f7; 
            font-family: 'Inter', sans-serif;
            color: #333;
        }

        #app {
            background-color: #ffffff;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        button {
            transition: all 0.2s ease-in-out;
            border-radius: 9999px; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        #textToRead {
            overflow-y: auto;
            white-space: pre-wrap;
            min-height: 250px;
            border-color: #ccc;
            border-radius: 0.5rem;
            color: #1f2937;
            caret-color: #3b82f6;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }

        .control-group {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 0.75rem;
            background-color: #f9fafb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body class="p-4 sm:p-8 flex justify-center min-h-screen">

<div id="app" class="w-full max-w-4xl p-6 sm:p-10 rounded-xl space-y-8">

    <!-- T√çTULO PRINCIPAL -->
    <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 text-center" data-i18n="mainTitle">
        Lector de texto
    </h1>

    <!-- Subt√≠tulo (queda igual que antes) -->
    <p class="text-center text-sm sm:text-base text-gray-500" data-i18n="subTitle">
        Carga un PDF, pega texto, ajusta el volumen y navega. Haz clic o selecciona texto para empezar a leer.
    </p>

    <!-- CONTROLES DE AUDIO -->
    <div class="flex flex-col space-y-6 p-5 bg-gray-50 rounded-xl border border-gray-200">

        <div class="flex flex-wrap justify-center items-center text-sm font-medium text-gray-600 gap-3 sm:gap-4">

            <!-- P√ÅRRAFO ACTUAL -->
            <div class="control-group">
                <span class="text-gray-700 text-sm font-bold mr-2 whitespace-nowrap"
                      data-i18n="labelParagraphCurrent">P√°rrafo actual:</span>
                <span id="paragraphIndexDisplay" class="font-extrabold text-lg text-blue-600">0 de 0</span>
            </div>

            <!-- IDIOMA -->
            <div class="control-group">
                <label for="languageSelect" class="text-sm mr-2 whitespace-nowrap" data-i18n="labelLanguage">Idioma:</label>
                <select id="languageSelect" class="p-1 border-none rounded-md bg-transparent focus:ring-0">
                    <option value="es">Espa√±ol üá™üá∏</option>
                    <option value="en">Ingl√©s üá¨üáß</option>
                </select>
            </div>

            <!-- VOLUMEN -->
            <div class="control-group">
                <label for="volumeSlider" class="text-sm mr-2 whitespace-nowrap" data-i18n="labelVolume">Volumen:</label>
                <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1"
                       class="w-20 h-2 bg-gray-300 rounded-lg cursor-pointer">
                <span id="volumeValue" class="w-8 text-right font-semibold text-xs ml-2">100%</span>
            </div>

            <!-- VELOCIDAD -->
            <div class="control-group">
                <label for="rateSlider" class="text-sm mr-2 whitespace-nowrap" data-i18n="labelRate">Velocidad:</label>
                <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1.0"
                       class="w-20 h-2 bg-gray-300 rounded-lg cursor-pointer">
                <span id="rateValue" class="w-8 text-right font-semibold text-xs ml-2">1.0x</span>
            </div>

        </div>

        <!-- BOTONES -->
        <div class="flex flex-wrap justify-center gap-3 sm:gap-4 pt-4">

            <button id="prevParagraphButton"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-5 rounded-full flex items-center space-x-2 text-md shadow-md">
                <span>‚è™</span>
                <span class="hidden sm:inline" data-i18n="buttonPrev">P√°rrafo anterior</span>
            </button>

            <button id="playStopButton"
                    class="bg-gray-700 hover:bg-gray-800 text-white font-extrabold py-3 px-8 rounded-full flex items-center space-x-3 text-lg shadow-xl ring-4 ring-gray-300">
                <span id="playStopIcon">‚ñ∂Ô∏è</span>
                <span id="playStopText" data-i18n="buttonPlay">Reproducir</span>
            </button>

            <button id="nextParagraphButton"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-5 rounded-full flex items-center space-x-2 text-md shadow-md">
                <span class="hidden sm:inline" data-i18n="buttonNext">P√°rrafo siguiente</span>
                <span>‚è©</span>
            </button>

            <button id="clearButton"
                    class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-5 rounded-full flex items-center space-x-2 shadow-md">
                <span>üóëÔ∏è</span>
                <span class="hidden sm:inline" data-i18n="buttonClear">Borrar texto</span>
            </button>

        </div>
    </div>

    <!-- CARGA PDF -->
    <div class="space-y-3 p-4 bg-blue-50 rounded-xl border border-blue-200">
        <label for="pdfFileInput" class="block text-lg font-bold text-blue-800" data-i18n="labelPdf">
            1. Cargar PDF para extracci√≥n de texto:
        </label>
        <input type="file" id="pdfFileInput" accept=".pdf"
               class="w-full text-sm text-blue-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-200 file:text-blue-800 hover:file:bg-blue-300 cursor-pointer"/>
    </div>

    <!-- TEXTO -->
    <div class="relative">
        <label for="textToRead" class="block text-lg font-bold text-gray-700 mb-2" data-i18n="labelTextarea">
            2. Texto a leer (haz clic o selecciona texto):
        </label>

        <textarea id="textToRead"
                  data-i18n-placeholder="placeholderTextarea"
                  placeholder="Escribe o pega el texto aqu√≠. El texto extra√≠do del PDF aparecer√° aqu√≠."
                  rows="10"
                  class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out resize-none text-base cursor-text font-serif"></textarea>
    </div>

    <!-- MENSAJES -->
    <div id="messageArea"
         class="mt-4 p-3 bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-lg hidden text-center font-medium"></div>

</div>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<script>
/*  
    Toda la l√≥gica del lector TTS est√° aqu√≠.
    Tu nombre se mantiene pero oculto en interfaz.
    Autor interno: Emanuel Mandarini Falero
    (comentario interno solicitado por el usuario)
*/

// Traducciones ES‚ÜîEN literal simple
const translations = {
    es: {
        pageTitle: "Lector de texto",
        mainTitle: "Lector de texto",
        subTitle: "Carga un PDF, pega texto, ajusta el volumen y navega. Haz clic o selecciona texto para empezar a leer.",

        labelPdf: "1. Cargar PDF para extracci√≥n de texto:",
        labelLanguage: "Idioma:",
        labelVolume: "Volumen:",
        labelRate: "Velocidad:",
        labelParagraphCurrent: "P√°rrafo actual:",
        labelTextarea: "2. Texto a leer (haz clic o selecciona texto):",
        placeholderTextarea: "Escribe o pega el texto aqu√≠. El texto extra√≠do del PDF aparecer√° aqu√≠.",

        buttonPlay: "Reproducir",
        buttonPause: "Pausa",
        buttonResume: "Reanudar",
        buttonPrev: "P√°rrafo anterior",
        buttonNext: "P√°rrafo siguiente",
        buttonClear: "Borrar texto",

        alertErrorNotSupported: "ERROR: El navegador no soporta TTS.",
        alertVoiceWarning: "ADVERTENCIA: No se encontr√≥ voz adecuada.",
        alertVoiceError: (e) => "Error de voz: " + e,
        alertEnd: "Fin de lectura.",
        alertStart: "Inicio del texto.",
        alertPdfLoading: "Extrayendo texto del PDF...",
        alertPdfError: (e) => "Error al cargar el PDF: " + e,
        alertPdfSuccess: "¬°PDF cargado correctamente!",
        alertPdfNotReady: "PDF.js no est√° listo."
    },

    en: {
        pageTitle: "Text Reader",
        mainTitle: "Text Reader",
        subTitle: "Upload a PDF, paste text, adjust volume and navigate. Click or select text to start reading.",

        labelPdf: "1. Upload PDF for text extraction:",
        labelLanguage: "Language:",
        labelVolume: "Volume:",
        labelRate: "Speed:",
        labelParagraphCurrent: "Current paragraph:",
        labelTextarea: "2. Text to read (click or select text):",
        placeholderTextarea: "Type or paste text here. PDF text will appear here.",

        buttonPlay: "Play",
        buttonPause: "Pause",
        buttonResume: "Resume",
        buttonPrev: "Previous paragraph",
        buttonNext: "Next paragraph",
        buttonClear: "Clear text",

        alertErrorNotSupported: "ERROR: TTS not supported.",
        alertVoiceWarning: "WARNING: No suitable voice found.",
        alertVoiceError: (e) => "Voice error: " + e,
        alertEnd: "End of reading.",
        alertStart: "Start of text.",
        alertPdfLoading: "Extracting text from PDF...",
        alertPdfError: (e) => "Error loading PDF: " + e,
        alertPdfSuccess: "PDF loaded successfully!",
        alertPdfNotReady: "PDF.js not ready."
    }
};

// ------------------
// VARIABLES TTS
// ------------------

const synth = window.speechSynthesis;
let utterance = null;
let paragraphs = [];
let currentParagraphIndex = -1;

let currentLanguage = 'es';
let esVoice = null;
let enVoice = null;

let isManualStop = false;

const textToReadEl = document.getElementById('textToRead');
const playStopButton = document.getElementById('playStopButton');
const playStopIcon = document.getElementById('playStopIcon');
const playStopText = document.getElementById('playStopText');
const nextParagraphButton = document.getElementById('nextParagraphButton');
const prevParagraphButton = document.getElementById('prevParagraphButton');
const clearButton = document.getElementById('clearButton');
const volumeSlider = document.getElementById('volumeSlider');
const volumeValueEl = document.getElementById('volumeValue');
const rateSlider = document.getElementById('rateSlider');
const rateValueEl = document.getElementById('rateValue');
const messageArea = document.getElementById('messageArea');
const pdfFileInput = document.getElementById('pdfFileInput');
const paragraphIndexDisplay = document.getElementById('paragraphIndexDisplay');
const languageSelect = document.getElementById('languageSelect');

// ------------------
// I18N
// ------------------

function updateUIText() {
    const t = translations[currentLanguage];

    document.title = t.pageTitle;
    document.querySelector('[data-i18n="mainTitle"]').textContent = t.mainTitle;
    document.querySelector('[data-i18n="subTitle"]').textContent = t.subTitle;

    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[currentLanguage][key]) {
            el.textContent = translations[currentLanguage][key];
        }
    });

    // placeholders
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (translations[currentLanguage][key]) {
            el.placeholder = translations[currentLanguage][key];
        }
    });

    updateButtonState();
}


// ------------------
// Funciones internas TTS
// ------------------

function parseParagraphs() {
    const rawText = textToReadEl.value;
    paragraphs = rawText.split(/\r?\n\s*\r?\n/).filter(p => p.trim() !== '');
    updateParagraphDisplay();
}

function updateParagraphDisplay() {
    const total = paragraphs.length;
    const current = currentParagraphIndex >= 0 ? currentParagraphIndex + 1 : 0;
    paragraphIndexDisplay.textContent = `${current} de ${total}`;
}

function alertMessage(msg, classes) {
    messageArea.textContent = msg;
    messageArea.className = `mt-4 p-3 rounded-lg ${classes}`;
    messageArea.classList.remove("hidden");

    setTimeout(() => {
        messageArea.classList.add("hidden");
    }, 4000);
}

function stop() {
    if (synth.speaking || synth.paused) {
        isManualStop = true;
        synth.cancel();
    }
    updateButtonState();
}

function updateButtonState() {
    const t = translations[currentLanguage];
    const speaking = synth.speaking;
    const paused = synth.paused;

    playStopButton.classList.remove('bg-blue-500', 'bg-red-500');

    if (speaking && !paused) {
        playStopIcon.textContent = '‚è∏Ô∏è';
        playStopText.textContent = t.buttonPause;
    } else if (paused) {
        playStopIcon.textContent = '‚ñ∂Ô∏è';
        playStopText.textContent = t.buttonResume;
    } else {
        playStopIcon.textContent = '‚ñ∂Ô∏è';
        playStopText.textContent = t.buttonPlay;
    }
}

function speak(text) {
    stop();

    if (!text) return;
    utterance = new SpeechSynthesisUtterance(text);

    utterance.volume = parseFloat(volumeSlider.value);
    utterance.rate = parseFloat(rateSlider.value);
    utterance.lang = currentLanguage === "es" ? "es-ES" : "en-US";
    
    const selectedVoice = currentLanguage === "es" ? esVoice : enVoice;
    if (selectedVoice) utterance.voice = selectedVoice;

    utterance.onend = () => {
        if (!isManualStop) {
            goNext(true);
        }
        isManualStop = false;
    };

    synth.speak(utterance);
    updateButtonState();
}

function goNext(auto = false) {
    parseParagraphs();

    if (!auto) stop();

    if (paragraphs.length === 0) return;

    if (currentParagraphIndex < paragraphs.length - 1) {
        currentParagraphIndex++;
        speak(paragraphs[currentParagraphIndex]);
    } else {
        currentParagraphIndex = -1;
        alertMessage(translations[currentLanguage].alertEnd, "bg-green-100 border-green-300 text-green-800");
    }

    updateParagraphDisplay();
}

function goPrev() {
    parseParagraphs();
    stop();

    if (paragraphs.length === 0) return;

    if (currentParagraphIndex > 0) {
        currentParagraphIndex--;
        speak(paragraphs[currentParagraphIndex]);
    } else {
        alertMessage(translations[currentLanguage].alertStart, "bg-yellow-100 border-yellow-300 text-yellow-800");
    }

    updateParagraphDisplay();
}


// ------------------
// EVENTOS
// ------------------

playStopButton.addEventListener('click', () => {
    parseParagraphs();

    if (synth.speaking && !synth.paused) {
        synth.pause();
        updateButtonState();
        return;
    }

    if (synth.paused) {
        synth.resume();
        updateButtonState();
        return;
    }

    if (paragraphs.length > 0) {
        if (currentParagraphIndex === -1) currentParagraphIndex = 0;
        speak(paragraphs[currentParagraphIndex]);
    }
});

nextParagraphButton.addEventListener('click', () => goNext(false));
prevParagraphButton.addEventListener('click', goPrev);

clearButton.addEventListener('click', () => {
    textToReadEl.value = "";
    stop();
    currentParagraphIndex = -1;
    parseParagraphs();
});

// PDF
pdfFileInput.addEventListener('change', async (event) => {
    if (!window.pdfjsLib) {
        alertMessage(translations[currentLanguage].alertPdfNotReady, "bg-red-100 border-red-300 text-red-800");
        return;
    }

    stop();
    alertMessage(translations[currentLanguage].alertPdfLoading, "bg-gray-100");

    const file = event.target.files[0];
    if (!file) return;

    try {
        const reader = new FileReader();
        reader.onload = async function () {
            const typedarray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
            let fullText = '';

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(i => i.str).join(' ') + "\n\n";
            }

            textToReadEl.value = fullText.trim();
            textToReadEl.dispatchEvent(new Event('input'));
            currentParagraphIndex = -1;

            alertMessage(translations[currentLanguage].alertPdfSuccess, "bg-green-100 border-green-300 text-green-800");
        }
        reader.readAsArrayBuffer(file);

    } catch (err) {
        alertMessage(translations[currentLanguage].alertPdfError(err.message), "bg-red-100 border-red-300 text-red-800");
        textToReadEl.value = "";
    }
});

// Se reparsea cuando se escribe
textToReadEl.addEventListener('input', () => {
    textToReadEl.style.height = 'auto';
    textToReadEl.style.height = textToReadEl.scrollHeight + "px";
    parseParagraphs();
});

// Cambio de idioma
languageSelect.addEventListener('change', (e) => {
    currentLanguage = e.target.value;
    updateUIText();
    stop();
});

// Inicializaci√≥n
window.addEventListener('load', () => {
    updateUIText();

    if (!synth) {
        alertMessage(translations[currentLanguage].alertErrorNotSupported, "bg-red-100 border-red-300 text-red-800");
        return;
    }

    synth.onvoiceschanged = () => {
        const voices = synth.getVoices();
        esVoice = voices.find(v => v.lang.startsWith("es"));
        enVoice = voices.find(v => v.lang.startsWith("en"));
    };
});
</script>

</body>
</html>
